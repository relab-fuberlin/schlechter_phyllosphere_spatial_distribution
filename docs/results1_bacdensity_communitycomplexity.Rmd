---
title: "Bacterial community complexity in the phyllosphere penalises specialists over generalists - Results Section 1"
author: "Rudolf Schlechter"
output:
  html_document:
    df_print: paged
    keep_md: yes
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align='center', dpi = 300, cache = TRUE)
options(digits = 2, scipen = 1, pillar.signif = 3)

# Libraries
library(here)
library(tidyverse)
library(car)
library(rstatix)
library(forcats)
library(emmeans)
library(lme4)
library(multcomp)

# Plotting 
library(ggdist)
library(ggpubr)
library(patchwork)

# Other dependencies
source(here('code', 'palette_syncom.R'))
source(here('code', 'theme_rs_spatial.R'))
source(here('code', 'dunnet_function.R'))
source(here('code', 'function_triad.R'))

set.seed(19900725)

```

## Taxon-specific population density changes correlate with community complexity

```{r import_data, include=FALSE}
# Load data
data_cfu <- read.csv(here("results", "data_processed.csv")) %>% 
    na.omit %>% 
    mutate(dpi = factor(dpi),
           synID = factor(synID),
           taxa = factor(taxa))
```

```{r cfu_str}
data_cfu %>% head
```

```{r}
# Linear regression for testing normality and homoscedasticity
linear_cfu = lm(cfu_log ~ synID + dpi + taxa, data_cfu)

# Shapiro-Wilk test for normality
cfu_normality = shapiro.test(rstandard(linear_cfu)); cfu_normality

# Breusch-Pagan test for homogeneity of variances
cfu_homoskedasticity = ncvTest(linear_cfu); cfu_homoskedasticity
```

We explored the impact of community complexity on bacterial population densities *in planta*, focusing on two prominent bacterial taxa, *Methylobacterium* and *Sphingomonas*. Employing a full factorial design, we evaluated bacterial population densities across varying levels of community complexities, characterised by three conditions: near-isogenic control (C), a two-species SynCom (S2), and a three-species SynCom (S3) at 7- and 14-days post-inoculation (dpi).

We used non-parametric methods to analyse the CFU data, considering violation of normality (Shapiro-Wilk test, *W* = `r cfu_normality$statistic`, *p* = `r cfu_normality$p.value`) and homogeneity of variance (Breusch-Pagan test, $\ X^{2}$ = `r cfu_homoskedasticity$ChiSquare`, *p* = `r cfu_homoskedasticity$p`)


```{r cfu_analysis_synID}
# Kruskal-Wallis test and effect size for community complexity (synID)
kw_synID = data_cfu %>% 
    kruskal_test(cfu_log ~ synID) %>% 
    mutate(p_label = case_when(
        p < 0.05 ~ "< 0.05", 
        TRUE ~ as.character(p)))

keff_synID = data_cfu %>% 
    kruskal_effsize(cfu_log ~ synID, nboot=100)

# Dunn's Test
dunn_synID = data_cfu %>% 
    group_by(dpi) %>% 
    dunn_test(cfu_log ~ synID, p.adjust.method = "holm")

# Fold change of population density by SynCom complexity (synID)
fc_cfu_synID = data_cfu %>% 
    # Group by SynCom (C, S2, S3)
    group_by(synID) %>% 
    summarise(median_cfu = median(cfu)) %>% 
    # Calculate the fold change (FC) in relation to C
    mutate(FC = median_cfu/median_cfu[1],
           logFC = log2(FC))
```

We first tested the influence of community complexity on individual bacterial populations at the CFU level, showing a pronounced and statistically significant effect (Kruskal-Wallis, *H*(`r kw_synID$df`) = `r kw_synID$statistic`, *p* `r kw_synID$p_label`). This effect was reflected by a significant `r fc_cfu_synID$FC[fc_cfu_synID$synID=="S2"]`-fold increase in population densities within two-species communities (Dunn's test, *Z* = `r abs(dunn_synID$statistic[1])`, *p*-adjusted `r dunn_synID$p_label[1]`), and a pronounced `r (fc_cfu_synID$FC[fc_cfu_synID$synID=="S3"])^-1`-fold reduction in the three-species communities (Dunn's test, *Z* = `r abs(dunn_synID$statistic[2])`, *p*-adjusted `r dunn_synID$p_label[2]`), relative to the near-isogenic control.


```{r cfu_analysis_dpi}
# Wilcoxon test and effect size for sampling time (dpi)
w_dpi = data_cfu %>% 
    rstatix::wilcox_test(formula = cfu_log ~ dpi) %>% 
    mutate(p_label = case_when(
        p < 0.05 ~ "< 0.05", 
        TRUE ~ as.character(p)))

weff_dpi = data_cfu %>% 
    wilcox_effsize(formula = cfu_log ~ dpi, ci = TRUE, nboot = 100)

# Fold change of population density by time of sampling (dpi)
fc_cfu_dpi = data_cfu %>% 
    # Group by day (7, 14 dpi)
    group_by(dpi) %>% 
    summarise(median_cfu = median(cfu)) %>% 
    # Calculate the fold change (FC) in relation to 7 dpi
    mutate(FC = median_cfu/median_cfu[1],
           logFC = log2(FC))
```

Subsequently, we considered the temporal changes as an influencing factor in population density and evaluated how population density changed between the two sampling points. Here we observed a small yet significant temporal effect on population density (Wilcoxon, *W* = `r w_dpi$statistic`, *p* `r w_dpi$p_label`), with a `r fc_cfu_dpi$FC[fc_cfu_dpi$dpi=="14dpi"]`-fold increase between 7 and 14 dpi.

```{r cfu_analysis_taxa}
# Wilcoxon test and effect size for bacterial group (taxa)
w_taxa = data_cfu %>% 
    wilcox_test(formula = cfu_log ~ taxa) %>% 
    mutate(p_label = case_when(
        p < 0.05 ~ "< 0.05", 
        TRUE ~ as.character(p)))

weff_taxa = data_cfu %>% 
    wilcox_effsize(formula = cfu_log ~ taxa, ci = TRUE, nboot = 100)

# Fold change of population density by bacterial group (taxa)
fc_cfu_taxa = data_cfu %>% 
    # Group by taxa (Sphingomonas, Methylobacterium)
    group_by(taxa) %>% 
    summarise(median_cfu = median(cfu)) %>% 
    # Calculate the fold change (FC) in relation to Methylobacterium
    mutate(FC = median_cfu/median_cfu[1],
           logFC = log2(FC))
```

```{r, include=FALSE}
## Fold change and Dunn tests for two variables

## Variables
explanatory = "synID"
taxa_dpi = c("taxa", "dpi")
strain_dpi = c("strain", "dpi")

# Fold change of population density by taxa and dpi
dunntest_taxa_dpi <- dun_func1(data_cfu, "cfu_log", taxa_dpi, explanatory) %>% 
    mutate(symbol = ifelse(p_label == "< 0.05", "*", "")) %>% 
    rename(synID = group2)
fold_taxa_dpi <- fold_func1(data_cfu, "cfu", taxa_dpi, explanatory)

# Fold change of population density by strain and dpi
dunntest_strain_dpi <- dun_func1(data_cfu, "cfu_log", strain_dpi, explanatory) %>% 
    mutate(symbol = ifelse(p_label == "< 0.05", "*", "")) %>% 
    rename(synID = group2)
fold_strain_dpi <- fold_func1(data_cfu, "cfu", strain_dpi, explanatory)
```

Next, we evaluated the changes in populations of specific bacterial taxa, and found that *Methylobacterium* population densities were notably different to *Sphingomonas* (Wilcoxon, *Z* = `r w_taxa$statistic`, *p* `r w_taxa$p_label`). *Sphingomonas* population densities were `r fc_cfu_taxa$FC[fc_cfu_taxa$taxa=="Sphingomonas"]` times larger than those of *Methylobacterium*. Within *Sphingomonas*, SmFR1 consistently increased population sizes in S2, irrespective of the presence of a second species, and to a lesser extent in S3. By contrast, SpFA2 population sizes showed a transient increase in S2, but predominantly decreased in S3.

*Methylobacterium* populations responded negatively to increasing community complexity. MeL85, MeL92, and Mr0-1 consistently experienced a reduction in population sizes, particularly within S3 and, to a lesser extent, in S2. Among the *Methylobacterium* species, MeL92 and Mr0-1 benefited from the presence of any other species (S2). However, this effect was only observed at 14 dpi, and it was lost in the presence of a third competitor (S3). MeL85 was the most susceptible to population decrease over time, and across varying community complexities and compositions.

Collectively, these findings indicate that bacterial taxa differentially responded to community complexity within the leaf environment. Notably, *Methylobacterium* populations were more susceptible compared to sphingomonads. Among the studied species, *Sphingomonas* FR1 emerged as the most competitive, while *Methylobacterium* L85 was the least competitive.

## Figures

```{r figure_main_3_setup, include = FALSE}
# Plot CFU
# Multiple comparisons
plt.cfu.stat = dunn_synID %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "synID")

# Plot A
plt.a <- data_cfu %>% 
    ggplot(aes(synID, cfu_log))+
    stat_eye(
        side="right",
        adjust = 1,
        justification = -0.3,
        .width = 0,
        scale = 0.5,
        point_colour = NA)+
    geom_jitter(width = 0.1, alpha = 0.1)+
    geom_boxplot(fill = "white", width=0.2, outlier.alpha = 0)+
    coord_cartesian(xlim=c(1, 3.2))+
    stat_pvalue_manual(
        data = plt.cfu.stat,
        size = 4,
        label = "p.adj.signif",
        xmin = "group1", xmax = "group2",
        y.position = "y.position")+
    scale_y_continuous(limits = c(3.5, 10.2), breaks = c(4, 6, 8, 10))+
    labs(y = plt_bac_density_lab,
         x = "SynCom")+
    theme_rs()+
    theme(axis.text.x = element_text(hjust = 0.5, vjust = 1.5))

# Plot B
plt.b <- inner_join(dunntest_taxa_dpi, fold_taxa_dpi, by = c("taxa", "dpi", "synID")) %>% 
    mutate(label = paste0(sprintf(log2FC, fmt = '%#.2f'), symbol)) %>% 
    filter(group1 == "C") %>% 
    ggplot(aes(x = synID, y = taxa))+
    facet_wrap(~dpi, ncol = 2, labeller = labeller(dpi = dpi.lab2))+
    geom_tile(aes(fill = log2FC), colour = "black")+
    geom_text(aes(label = label), vjust = 0.5, size = 2)+
    scale_fill_gradientn(name = bquote(Log[2]~"FC"), 
                         colours = wes_palette("Zissou1"), 
                         values = c(0,0.5,1), 
                         limits = c(-8,4), 
                         breaks = seq(-8,4,4), 
                         na.value = 'grey90')+
    scale_y_discrete(name = "", labels = taxa.lab)+
    labs(x = "")+
    theme_rs()+
    theme(panel.border = element_blank(),
          axis.text.x = element_text(hjust = 0.5, vjust = 3),
          axis.text.y = element_text(face = "italic"),
          strip.text = element_text(face = "plain"),
          legend.position = "bottom")

# Plot C
plt.c <- inner_join(dunntest_strain_dpi, fold_strain_dpi, by = c("strain", "dpi", "synID")) %>% 
    mutate(label = paste0(sprintf(log2FC, fmt = '%#.2f'), symbol)) %>% 
    filter(group1 == "C") %>% 
    ggplot(aes(x = synID, y = strain))+
    facet_wrap(~dpi, ncol = 2, labeller = labeller(dpi=dpi.lab2))+
    geom_tile(aes(fill = log2FC), colour = "black")+
    geom_text(aes(label = label), vjust = 0.5, size = 2)+
    scale_fill_gradientn(name = bquote(Log[2]~"FC"), 
                         colours = wes_palette("Zissou1"), 
                         values = c(0,0.5,1), 
                         limits = c(-8,4), 
                         breaks = seq(-8,4,4), 
                         na.value = 'grey90')+
    scale_y_discrete(name = "Focal strain", labels = sp.lab)+
    scale_x_discrete(name = "SynCom")+
    theme_rs()+
    theme(panel.border = element_blank(),
          axis.text.x = element_text(hjust = 0.5, vjust = 3),
          strip.text = element_text(face = "plain"),
          legend.position = "bottom")
```

```{r figure_2, fig.id=TRUE, fig.cap="Bacterial population density in the arabidopsis phyllosphere", fig.width=3.5, out.width="50%"}

wrap_plots(wrap_elements(plot = plt.a), plt.b, plt.c, ncol = 1) + 
    plot_annotation(tag_levels = "A") + 
    plot_layout(guides = "collect",
                heights = c(6,1,2)) & 
    theme(legend.box.just = "left",
          legend.position = "bottom",
          panel.spacing.x = unit(0.5, "lines"),
          plot.margin = margin(1,1,0,1),
          plot.tag = element_text(size = 7)) &
    guides(fill = guide_colorbar(title.position="top", title.hjust = 0.5, barheight = unit(0.1, 'in')))

# Save plot
ggsave(here("results", "figure_2.png"), width = 3, height = 6)
ggsave(here("results", "figure_2.tiff"), width = 3, height = 6)

```

# Supplemental Figure

```{r figure_sup_1_setup, include=FALSE}
dunntest_syncom <- dun_func1(data_cfu, "cfu_log", c("strain", "dpi"), "syncom") %>% 
    separate(group1, into=c('synID', 'com')) %>% 
    mutate(symbol = ifelse(p_label == "< 0.05", "*", "")) %>% 
    rename(syncom = group2) %>% 
    group_by(strain, dpi) %>% 
    filter(synID=="C") %>% 
    select(-synID:-com)

dunn_S2 = dunntest_syncom %>% 
    separate(syncom, into = c('synID', 'com'), remove = FALSE) %>% 
    filter(synID == "S2") %>% 
    select(syncom, dpi, strain, symbol) %>% 
    group_by(syncom, dpi) %>% 
    mutate(to = rev(strain)) %>% 
    ungroup() %>% 
    select(syncom, dpi, strain, to, symbol)

dunn_test_long <- dunntest_syncom %>% 
    separate(syncom, into = c('synID', 'com'), remove = FALSE) %>% 
    filter(synID == "S3") %>% 
    mutate(to = syncom) %>% 
    select(syncom, dpi, strain, to, symbol) %>% 
    rbind(dunn_S2,.) %>% 
    select(dpi:symbol) %>% 
    rename(name=to)

data_median_control = data_cfu %>% 
    filter(synID == "C") %>% 
    group_by(strain, dpi) %>% 
    summarise(m_mono = median(cfu), .groups="drop")

data_fold = data_cfu %>% 
    group_by(synID, syncom, strain, dpi) %>% 
    summarise(m = median(cfu), .groups="drop") %>% 
    inner_join(., data_median_control, by = c("strain", "dpi")) %>%
    filter(synID != "C") %>% 
    mutate(fold = log2(m/m_mono)) %>% 
    left_join(., dunntest_syncom, by = c("strain", "syncom", "dpi"))

data_fold_S2 = data_fold %>% 
    filter(synID == "S2") %>% 
    select(syncom, strain, fold, dpi) %>% 
    group_by(syncom, dpi) %>% 
    mutate(to=rev(strain)) %>% 
    pivot_wider(id_cols=c(strain, dpi), names_from = to, values_from = fold) %>% 
    select(strain, dpi, meL85, meL92, mr01, smfr1, spfa2) %>% 
    arrange(strain)

data_fold_S3 = data_fold %>% 
    filter(synID == "S3") %>% 
    pivot_wider(id_cols=c(strain, dpi), names_from = syncom, values_from=fold) %>% 
    arrange(strain)

```

```{r figure_s2, warning=FALSE, fig.width=3.5, fig.height=3, out.width="50%"}

# Plot
plt.sup = cbind(data_fold_S2, data_fold_S3[,c(-1:-2)]) %>% 
    pivot_longer(cols = -c(strain,dpi)) %>% 
    ungroup %>% 
    mutate(label = if_else(grepl("S3.*", name), "S3", "S2"),
           index = seq(1:nrow(.))) %>% 
    left_join(., dunn_test_long, by = c("strain", "dpi", "name")) %>% 
    ggplot(aes(y = strain, x = fct_reorder(name, index)))+
    facet_grid(dpi~label, labeller = labeller(dpi = dpi.lab2), scales = "free_x", space = "free")+
    geom_tile(aes(fill = value), colour= "black")+
    geom_text(aes(label=symbol), vjust = 0.77, size = 5)+
    scale_fill_gradientn(name = bquote(Log[2]~"FC"), 
                         colours = wes_palette("Zissou1")[c(1,2,3,5,5)], 
                         values = c(0,0.57,1), limits=c(-10,8), 
                         breaks = seq(-8,4,4), na.value = 'grey90')+
    scale_y_discrete(name="Focal strain", labels = sp.lab)+
    scale_x_discrete(name="Competitor(s)", labels = sp.lab)+
    theme_rs()+
    theme(panel.border = element_blank(),
          axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          strip.text = element_text(face = "plain"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")+
    guides(fill = guide_colorbar(title.position="left", title.vjust = 0.75))

plt.sup

# Save plot  
ggsave(here("results", "figure_s2.png"), width = 3.5, height = 3)
ggsave(here("results", "figure_s2.tiff"), width = 3.5, height = 3)
```


## Resubmission
### Compare two-member sets within S3
We were asked to analyse the change in bacterial abundance within the three two-member sets of each S3 (normalise by pair)


```{r}
# Split the data
split_data <- split(data_cfu, 
                    list(data_cfu$synID, data_cfu$syncom, data_cfu$exp, data_cfu$sample, data_cfu$dpi), 
                    drop = TRUE,
                    sep = "_")

# Apply the function to each group
result_list <- lapply(split_data, process_triad)

# Combine the results into a single dataframe
final_result <- do.call(rbind, result_list)

# Clean data
cfu_pair_full <- final_result %>% 
    rownames_to_column(var = "label") %>% 
    separate(label, into = c("synID", "syncom", "exp", "sample", "dpi"), sep = "_") %>% 
    separate(dpi, into = c("dpi", "combn"), convert = TRUE) %>% 
    unite(strain1:strain2, col = "pair") %>% 
    mutate(log_cfu = log10(sum),
           taxa_pair = case_when(
            pair == "meL85_meL92" | 
                pair == "meL85_meL92" | 
                pair == "meL85_mr01" | 
                pair == "meL92_mr01" ~ "MM",
            pair == "meL85_smfr1" | 
                pair == "meL85_spfa2" | 
                pair == "meL92_smfr1" | 
                pair == "meL92_spfa2" | 
                pair == "mr01_smfr1" | 
                pair == "mr01_spfa2" ~ "MS",
            pair == "smfr1_spfa2" ~ "SS"),
        taxa_excluded = case_when(
            excluded == "smfr1" | excluded == "spfa2" ~ "Sphingomonas",
            excluded == "meL85" | excluded == "meL92" | excluded == "mr01" ~ "Methylobacterium")) %>% 
    mutate(taxa_excluded = factor(taxa_excluded),
           taxa_pair = factor(taxa_pair))
    
```


First, we determine if there are differences between pair of taxa

```{r}
# Create a LMM to account for syncom as grouping factor
models <- cfu_pair_full %>% 
    filter(synID != "C") %>% 
    split(., .$dpi) %>% 
    lapply(., lmer, formula = log_cfu ~ taxa_pair * synID + (1 | syncom))

# Compare means and pairwise comparisons
emm_list <- lapply(models, emmeans, ~taxa_pair * synID)

contrast_list <- lapply(emm_list, cld, alpha = 0.05, Letters = letters, adjust = "BH") %>% 
    lapply(., data.frame) %>% 
    do.call(rbind, .) %>% 
    rownames_to_column(var = "dpi") %>% 
    mutate(across(where(is.character), ~ str_remove_all(., "\\s+")),
           dpi = str_replace(dpi, "\\.[0-9]", ""))

# Plot
plt_cfu_taxa_pair <- cfu_pair_full %>% 
    filter(synID != "C") %>% 
    ggplot(., aes(taxa_pair, log_cfu, fill = synID))+
    facet_grid(cols = vars(dpi), labeller = labeller(dpi = dpi.lab2))+
    geom_jitter(aes(group = synID), 
                position = position_jitterdodge(jitter.width = 0.45, dodge.width = 0.9), 
                alpha = 0.2, size = 0.5)+
    geom_boxplot(outlier.alpha = 0, alpha = 0.9, size = 0.2, width = 0.9)+
    geom_text(data = contrast_list, aes(label = .group, y = 9.5, group = synID), 
              size = 2, position = position_dodge(width = 0.9))+
    scale_y_continuous(limits = c(4, 9.8), breaks = c(4, 6, 8, 10))+
    scale_fill_manual(name = "SynCom", values = syn.pal[2:3], label = syn.lab)+
    theme_rs()+
    coord_flip()+
    labs(y = plt_bac_density_lab,
         x = "Taxa Pair")+
    theme(strip.text = element_text(face = "plain"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")
```

Then, we determine if there are differences between pairs

```{r}
# Create a LMM to account for syncom as grouping factor
models_pair <- cfu_pair_full %>% 
    filter(synID != "C") %>% 
    split(., list(.$dpi, .$synID), sep = "_") %>% 
    lapply(., lmer, formula = log_cfu ~ pair + (1 | syncom))

models_pair <- cfu_pair_full %>% 
    filter(synID != "C") %>% 
    split(., .$dpi, sep = "_") %>% 
    lapply(., lmer, formula = log_cfu ~ pair * synID + (1 | syncom))

# Compare means and pairwise comparisons
emm_pair <- lapply(models_pair, emmeans, ~synID | pair)

contrast_pair <- lapply(emm_pair, contrast, alpha = 0.05, "pairwise", adjust = "BH") %>% 
    lapply(., data.frame) %>% 
    do.call(rbind, .) %>% 
    rownames_to_column(var = "label") %>% 
    separate(label, into = "dpi") %>% 
    separate(contrast, into = c("group1", "group2"), sep = " - ") %>% 
    mutate(p.adj.signif = ifelse(p.value < 0.05, "*", "ns")) %>% 
    left_join(., unique(cfu_pair_full[,c(7,11)]), by = "pair")

# Plot
plt_cfu_strain_pair <- cfu_pair_full %>% 
    filter(synID != "C") %>% 
    ggplot(., aes(fct_reorder(pair, as.numeric(taxa_pair)), log_cfu))+
    facet_grid(cols = vars(dpi), labeller = labeller(dpi = dpi.lab2))+
    geom_jitter(aes(fill = synID), 
                position = position_jitterdodge(jitter.width = 0.45, dodge.width = 0.9), 
                alpha = 0.2, size = 0.5)+
    geom_boxplot(aes(fill = synID), outlier.alpha = 0, alpha = 0.9, size = 0.2, width = 0.9)+
    geom_text(data = contrast_pair, aes(label = p.adj.signif, y = 9.5), 
              size = 2, position = position_dodge(width = 0.9))+
    scale_x_discrete(labels = pair.lab2)+
    scale_y_continuous(limits = c(4, 9.8), breaks = c(4, 6, 8, 10))+
    scale_fill_manual(name = "SynCom", values = syn.pal[2:3], labels = syn.lab)+
    theme_rs()+
    coord_flip()+
    labs(y = plt_bac_density_lab,
         x = "Strain Pair")+
    theme(axis.text.x = element_text(hjust = 1, vjust = 0.5),
          strip.text = element_text(face = "plain"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")

```


This is the fold change

```{r}
## Data sets
cfu_pair <- cfu_pair_full %>% 
    group_by(synID, syncom, dpi, pair, taxa_pair, excluded, taxa_excluded) %>% 
    summarise(cfu_median = median(sum), .groups = "drop") %>%
    filter(synID != "C")

pair_S2 <- cfu_pair %>% 
    filter(synID == "S2") %>% 
    dplyr::select(dpi, pair, cfu_median)

pair_S3 <- cfu_pair %>% 
    filter(synID == "S3" & excluded != 'NA') %>% 
    left_join(., pair_S2, by = c("dpi", "pair"), suffix = c(".S3", ".S2")) %>% 
    mutate(fc_pair = log2(cfu_median.S3/cfu_median.S2))
``` 


```{r}
# Stats, compare the median log2 FC of pairs in S3 compared to S2
dunn_strain_pair <- pair_S3 %>% 
    group_by(dpi) %>% 
    dunn_test(fc_pair ~ pair, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_x_position(x = "pair")

dunn_allpair <- pair_S3 %>% 
    group_by(dpi) %>% 
    dunn_test(fc_pair ~ taxa_pair, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "taxa_pair")

dunn_taxapair <- pair_S3 %>% 
    group_by(dpi, taxa_excluded) %>% 
    dunn_test(fc_pair ~ taxa_pair, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "taxa_pair")

dunn_pair <- pair_S3 %>% 
    group_by(dpi, excluded) %>% 
    dunn_test(fc_pair ~ taxa_pair, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "taxa_pair")

```

##
```{r}
## Plots
plt_taxapair <- pair_S3 %>% 
    ggplot(., aes(x = taxa_pair, y = fc_pair))+
    facet_grid(cols = vars(dpi), labeller = labeller(dpi = dpi.lab2))+
    geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)+
    geom_jitter(alpha = 0.5, size = 0.8, width = 0.2)+
    geom_boxplot(aes(fill = taxa_pair), outlier.alpha = 0, alpha = 0.75, size = 0.2, width = 0.45)+
    stat_pvalue_manual(dunn_allpair, 
                       label = "p.adj.signif", tip.length = 0.02, 
                       size = 2, bracket.nudge.y = 0.2, hide.ns = TRUE, 
                       step.increase = 0.02, coord.flip = TRUE)+
    theme_rs()+
    scale_y_continuous(name = bquote(Log[2]~"FC Taxa pair"), limits = c(-6.5, 0))+
    scale_x_discrete(name = "Taxa pair")+
    scale_fill_manual(name = "Taxa pair", values = taxapair.pal, labels = taxapair.lab)+
    coord_flip()+
    theme(strip.text.x = element_text(face = "plain"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")

plt_taxastrain <- pair_S3 %>% 
    ggplot(., aes(x = fct_reorder(pair, as.numeric(taxa_pair)), y = fc_pair))+
    facet_grid(cols = vars(dpi), labeller = labeller(dpi = dpi.lab2))+
    geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)+
    geom_jitter(width = 0.1, alpha = 0.5, size = 0.8)+
    geom_boxplot(aes(fill = taxa_pair), outlier.alpha = 0, alpha = 0.75, size = 0.2, width = 0.45)+
    stat_pvalue_manual(dunn_strain_pair %>% 
                           filter(p.adj < 0.05) %>% 
                           mutate(xmin = 3, xmax = 10), 
                       label = "p.adj.signif", tip.length = 0.02,
                       y.position = -1, size = 2, bracket.nudge.y = 0.2, hide.ns = TRUE, 
                       step.increase = 0.02, coord.flip = TRUE)+
    theme_rs()+
    scale_y_continuous(name = bquote(Log[2]~"FC Taxa pair"), limits = c(-6.5, 0))+
    scale_x_discrete(name = "Strain pair", labels = pair.lab2)+
    scale_fill_manual(name = "Taxa pair", values = taxapair.pal, labels = taxapair.lab)+
    coord_flip()+
    theme(strip.text.x = element_text(face = "plain"),
          strip.text.y = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")
```

```{r}
wrap_plots(plt_cfu_taxa_pair, plt_taxapair, plt_cfu_strain_pair, plt_taxastrain, ncol = 2) + 
    plot_annotation(tag_levels = "A") + 
    plot_layout(heights = c(0.5,1), widths = c(1,1),
                guides = "collect") & 
    theme(legend.box.just = "left",
          legend.position = "bottom",
          panel.spacing.x = unit(0.5, "lines"),
          plot.margin = margin(1,1,0,1),
          plot.tag = element_text(size = 7)) &
    guides(fill = guide_legend(title.position="top", title.hjust = 0.5, barheight = unit(0.1, 'in')))

# Save plot  
ggsave(here("results", "figure_x1.png"), width = 6, height = 5)
ggsave(here("results", "figure_x1.tiff"), width = 6, height = 5)

```

##

```{r}
# Boxplots
plt1_taxapair <- pair_S3 %>% 
    ggplot(., aes(x = taxa_pair, y = fc_pair,  fill = taxa_excluded))+
    facet_grid(cols = vars(dpi), rows = vars(taxa_excluded), 
               labeller = labeller(dpi = dpi.lab2))+
    geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)+
    geom_jitter(aes(group = taxa_excluded), width = 0.2, alpha = 0.5, size = 0.8)+
    geom_boxplot(outlier.alpha = 0, alpha = 0.75, size = 0.2, width = 0.4)+
    stat_pvalue_manual(dunn_taxapair, label = "p.adj.signif", tip.length = 0.01, 
                       size = 2, bracket.nudge.y = 0.2, hide.ns = TRUE, 
                       step.increase = 0.02, coord.flip = TRUE)+
    theme_rs()+
    scale_y_continuous(name = bquote(Log[2]~"FC Focal taxa pair"), limits = c(-6.5, 0))+
    scale_x_discrete(name = "Focal taxa pair")+
    scale_fill_manual(name = "Tritagonist taxon", values = taxa.pal, labels = taxa.lab)+
    coord_flip()+
    theme(strip.text.x = element_text(face = "plain"),
          strip.text.y = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")

plt2_taxapair <- pair_S3 %>% 
    ggplot(., aes(x = taxa_pair, y = fc_pair,  fill = excluded))+
    facet_grid(cols = vars(dpi), rows = vars(excluded), 
               labeller = labeller(dpi = dpi.lab2, excluded = sp.lab))+
    geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)+
    geom_jitter(aes(group = taxa_excluded), width = 0.05, alpha = 0.5, size = 0.8)+
    geom_boxplot(outlier.alpha = 0, alpha = 0.75, size = 0.2, width = 0.4)+
    stat_pvalue_manual(dunn_pair, label = "p.adj.signif", tip.length = 0.01, 
                       size = 2, bracket.nudge.y = 0.2, hide.ns = TRUE, 
                       step.increase = 0.02, coord.flip = TRUE)+
    theme_rs()+
    scale_y_continuous(name = bquote(Log[2]~"FC Focal taxa pair"), limits = c(-6.5, 0))+
    scale_x_discrete(name = "Focal taxa pair")+
    scale_fill_manual(name = "Tritagonist strain", values = sp.pal, labels = sp.lab)+
    coord_flip()+
    theme(strip.text.x = element_text(face = "plain"),
          strip.text.y = element_blank(),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")


wrap_plots(wrap_elements(panel = rectGrob(gp = gpar(fill = 'white'))),
                         (plt1_taxapair + plt2_taxapair), ncol = 1)+
    plot_annotation(tag_levels = "A") + 
    plot_layout(heights = c(1, 2), widths = c(1,1)) &
    theme(legend.box.just = "left",
          legend.position = "bottom",
          panel.spacing.x = unit(0.5, "lines"),
          plot.margin = margin(1,1,0,1),
          plot.tag = element_text(size = 7)) &
    guides(fill = guide_legend(title.position="top", title.hjust = 0.5, barheight = unit(0.1, 'in')))

# Save plot  
ggsave(here("results", "figure_x2.png"), width = 6, height = 4)
ggsave(here("results", "figure_x2.tiff"), width = 6, height = 4)
ggsave(here("results", "figure_x2.pdf"), width = 6, height = 4)

```


Pairs of taxa (MM, MS, and SS) differ in their abundance in S3 compared to S2. All of them decreased but not at the same rate. MM pairs were the most affected, while MS and SS were not different to each other, except at 14 dpi, in which SS pairs (SmFR1 and SpFA2) were most similar to pairs alone (S2).

Tritagonists are tertiary main characters and we wanted to evaluate how the identity of a tritagonist could affect the change in abundance of a taxa pair. We observed that the presence of a Methylobacterium influenced the abundance of a taxa pair, in which MM+M were the most affected, while MS and SS were less so. The prescence of a Sphingomonas did not change the abundance of a taxa pair, except for SpFA2, in which its presence was associated to a larger decrease in the abundance of MM pairs compared to MS pairs, suggesting that SpFA2 could have detrimental effects for non-sphingomonads pairs.


```{r}
# Heatmaps pairs plots
plt1_pair <- pair_S3 %>% 
    group_by(synID, dpi, pair, taxa_pair, taxa_excluded) %>% 
    summarise(fc_pair = mean(fc_pair), .groups = "drop") %>% 
    ggplot(., aes(x = fct_reorder(pair, as.numeric(taxa_pair)), y = taxa_excluded))+
    facet_grid(cols = vars(dpi), scales = "free_x", labeller = labeller(dpi=dpi.lab2))+
    geom_tile(aes(fill = fc_pair))+
    geom_text(aes(label = sprintf(fc_pair, fmt = '%#.2f')), size = 2)+
    theme_rs()+
    scale_y_discrete(name="Tritagonist taxon", labels = taxa.lab)+
    scale_x_discrete(name="Strain pair", labels = pair.lab2)+
    scale_fill_gradientn(name = bquote(Log[2]~"FC"), 
                         colours = wes_palette("Zissou1"), 
                         values = c(0,0.5,1), 
                         limits = c(-8,4), 
                         breaks = seq(-8,4,4), 
                         na.value = 'grey90')+
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          strip.text = element_text(face = "plain"),
          axis.text.y = element_text(face = "italic"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")

plt2_pair <- pair_S3 %>% 
    ggplot(., aes(x = fct_reorder(pair, as.numeric(taxa_pair)), y = excluded))+
    facet_grid(cols = vars(dpi), scales = "free_x", labeller = labeller(dpi=dpi.lab2))+
    geom_tile(aes(fill = fc_pair))+
    geom_text(aes(label = sprintf(fc_pair, fmt = '%#.2f')), size = 2)+
    theme_rs()+
    scale_y_discrete(name="Tritagonist strain", labels = sp.lab)+
    scale_x_discrete(name="Strain pair", labels = pair.lab2)+
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
    scale_fill_gradientn(name = bquote(Log[2]~"FC"), 
                         colours = wes_palette("Zissou1"), 
                         values = c(0,0.5,1), 
                         limits = c(-8,4), 
                         breaks = seq(-8,4,4), 
                         na.value = 'grey90')+
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
          strip.text = element_text(face = "plain"),
          panel.spacing = unit(0.5, "lines"),
          legend.position = "bottom")

wrap_plots(plt1_pair, plt2_pair, ncol = 1)+
    plot_annotation(tag_levels = "A") + 
    plot_layout(guides = "collect",
                heights = c(2,5)) &
    theme(legend.box.just = "left",
          legend.position = "bottom",
          panel.spacing.x = unit(0.5, "lines"),
          plot.margin = margin(1,1,0,1),
          plot.tag = element_text(size = 7)) &
    guides(fill = guide_colorbar(title.position="top", title.hjust = 0.5, barheight = unit(0.1, 'in')))

# Save plot  
ggsave(here("results", "figure_x3.png"), width = 6, height = 4)
ggsave(here("results", "figure_x3.pdf"), width = 6, height = 4)

```

### Relative and total abundance data

```{r}
datatest <- split(data_cfu, list(data_cfu$dpi, data_cfu$syncom))

relative_fractions_list <- lapply(datatest, function(df) {
    df %>%
        group_by(dpi, synID, syncom, taxa, strain) %>% 
        summarise(cfu = median(cfu), .groups = "drop") %>% 
        mutate(relative_fraction = cfu / sum(cfu))
    })

relative_fractions <- do.call(rbind, relative_fractions_list) %>% 
    filter(synID != "C" & dpi == "14dpi")

plt_relfraction_taxa <- relative_fractions %>%
    ggplot(., aes(x = syncom, y = relative_fraction, fill = taxa))+
    facet_grid(cols = vars(dpi), scales = "free", labeller = labeller(dpi = dpi.lab2))+
    geom_col()+
    scale_fill_manual(name = "Taxa", values = taxa.pal, labels = taxa.lab)+
    theme_rs()+
    theme(legend.text = element_text(face = "italic"))

plt_relfraction_strain <- relative_fractions %>% 
    ggplot(., aes(x = syncom, y = relative_fraction, fill = strain))+
    facet_grid(cols = vars(dpi), scales = "free", labeller = labeller(dpi = dpi.lab2))+
    geom_col()+
    scale_fill_manual(name = "Strain", values = sp.pal, labels = sp.lab)+
    theme_rs()

wrap_plots(plt_relfraction_taxa, plt_relfraction_strain, ncol = 1)+
    plot_annotation(tag_levels = "A") &
    labs(x = "SynCom", y = "Relative fraction") &
    theme_rs() &
    theme(
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        legend.box.just = "left",
        legend.position = "bottom",
        panel.spacing.x = unit(0.5, "lines"),
        strip.text = element_text(face = "plain"),
        plot.margin = margin(1,1,0,1),
        plot.tag = element_text(size = 7)) &
    guides(fill = guide_legend(title.position="top", title.hjust = 0.5, barheight = unit(0.1, 'in')))

# Save plot  
ggsave(here("results", "figure_x4.png"), width = 4, height = 4)
ggsave(here("results", "figure_x4.pdf"), width = 4, height = 4)

```

### Use numeric output instead of heatmaps

```{r}
fc_cfu <- data_cfu %>% 
    group_by(synID, syncom, strain, dpi, taxa) %>% 
    summarise(m = median(cfu), .groups="drop") %>% 
    inner_join(., data_median_control, by = c("strain", "dpi")) %>%
    filter(synID != "C" & dpi == "14dpi") %>% 
    mutate(fold = log2(m/m_mono))

dunn_cfu_taxa = data_cfu %>% 
    filter(dpi == "14dpi") %>% 
    group_by(taxa) %>% 
    dunn_test(cfu_log ~ synID, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "synID")

##
plt_cfu <- data_cfu %>% 
    ggplot(aes(fct_rev(synID), cfu_log))+
    facet_grid(cols = vars(taxa), labeller = labeller(taxa = taxa.lab))+
    geom_jitter(width = 0.1, alpha = 0.1, size = 0.5)+
    geom_boxplot(aes(fill = synID), width = 0.2, outlier.alpha = 0, alpha = 0.9, size = 0.2)+
    add_pvalue(data = dunn_cfu_taxa, label = "p.adj.signif",
               xmin = "xmin", xmax = "xmax", tip.length = 0.01, 
               fontface = "italic", lineend = "round", bracket.size = 0.2, coord.flip = TRUE)+
    scale_y_continuous(limits = c(3.5, 10.2), breaks = c(4, 6, 8, 10))+
    scale_fill_manual(name = "SynCom", values = syn.pal, labels = syn.lab)+
    labs(y = plt_bac_density_lab,
         x = "SynCom")+
    theme_rs()+
    coord_flip()+
    theme(axis.text.x = element_text(hjust = 0.5, vjust = 1.5),
          strip.text.x = element_text(face = "plain"))+
    guides(fill = guide_legend(title.position="top", title.hjust = 0.5, barheight = unit(0.1, 'in')))

##
dunn_taxa_dpi <- fc_cfu %>% 
    group_by(dpi, taxa) %>% 
    dunn_test(fold ~ synID, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "taxa", dodge = 0.45)

fc_cfu_taxa <- fc_cfu %>% 
    ggplot(aes(x = taxa, y = fold))+
    geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)+
    geom_jitter(aes(fill = fct_rev(synID)), alpha = 0.2, size = 0.5, 
                position = position_jitterdodge(jitter.width = 0.3, dodge.width = 0.45))+
    geom_boxplot(aes(fill = fct_rev(synID)), 
                 outlier.alpha = 0, alpha = 0.9, size = 0.2, width = 0.45)+
    add_pvalue(dunn_taxa_dpi, label = "p.adj.signif", 
               xmin = "xmin", xmax = "xmax", tip.length = 0.01, 
               fontface = "italic", lineend = "round", bracket.size = 0.2, coord.flip = TRUE)+
    coord_flip()+
    scale_x_discrete(name = "", labels = taxa.lab)+
    scale_y_continuous(name = bquote(Log[2]~"FC Bacterial density"), 
                       limits = c(-10, 8))+
    scale_fill_manual(name = "SynCom", values = syn.pal[3:2], labels = syn.lab)+
    theme_rs()+
    guides(fill = "none")+
    theme(axis.text.x = element_text(hjust = 0.5, vjust = 3),
          axis.text.y = element_text(face = "italic"),
          strip.text = element_text(face = "plain"),
          legend.position = "bottom")

## 
dunn_strain_dpi <- fc_cfu %>% 
    group_by(dpi, strain) %>% 
    dunn_test(fold ~ synID, p.adjust.method = "BH") %>% 
    mutate(p.adj.signif = ifelse(p.adj < 0.05, "*", "ns")) %>% 
    add_xy_position(x = "strain", dodge = 0.9)

fc_cfu_strain <- fc_cfu %>% 
    ggplot(aes(x = strain, y = fold))+
    geom_hline(yintercept = 0, linetype = 2, linewidth = 0.3)+
    geom_jitter(aes(fill = fct_rev(synID)), alpha = 0.2, size = 0.5, 
                position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.9))+
    geom_boxplot(aes(fill = fct_rev(synID)), outlier.alpha = 0, 
                 alpha = 0.9, size = 0.2, width = 0.9)+
    add_pvalue(dunn_strain_dpi, label = "p.adj.signif", 
               xmin = "xmin", xmax = "xmax", tip.length = 0.01, 
               fontface = "italic", lineend = "round", bracket.size = 0.2, coord.flip = TRUE)+
    coord_flip()+
    scale_x_discrete(name = "", labels = sp.lab)+
    scale_y_continuous(name = bquote(Log[2]~"FC Bacterial density"), 
                       limits = c(-10, 8))+
    scale_fill_manual(name = "SynCom", values = syn.pal[3:2], labels = syn.lab)+
    theme_rs()+
    guides(fill = "none")+
    theme(axis.text.x = element_text(hjust = 0.5, vjust = 3),
          strip.text = element_text(face = "plain"),
          legend.position = "bottom")

wrap_plots(plt_cfu, fc_cfu_taxa + fc_cfu_strain, ncol = 1)+
    plot_annotation(tag_levels = "A") + 
    plot_layout(guides = "collect",
                heights = c(1,1)) &
    theme(legend.box.just = "left",
          legend.position = "bottom",
          panel.spacing.x = unit(0.5, "lines"),
          plot.margin = margin(1,1,0,1),
          plot.tag = element_text(size = 7))

# Save plot 
ggsave(here("results", "figure_x5.png"), width = 6, height = 5)
ggsave(here("results", "figure_x5.pdf"), width = 6, height = 5)

```
